# 채팅 API 명세

## HTTP API 명세

- 백앤드 모듈의 /docs 엔드포인트에 접근하면 Swagger로 작성된 명세를 확인할 수 있습니다.

## 소켓 API 명세

### 서버의 소켓 송신

서버에서 소켓 데이터를 송신할 때에는 다음 인터페이스를 준수합니다. 인터페이스의 필드들은 이벤트에 맞게 데이터를 송부해 줍니다.

```tsx
interface ISocketSend {
  rooms?: number[]; // 채팅방 번호 배열
  chatSeq?: number; // 채팅룸 ID
  userIDs?: number[]; // 동작을 수행할 대상의 userIDs 배열
  msg?: string; // 메시지
  id?: number; // 메시지일 경우 고유 ID
  kicked?: boolean; // 방에서 자진해서 나간건지 강퇴당했는지 여부
  role?: PartcAuth; // 유저의 권한이 변경될 때 권한을 나타냄
}
```

- event : `chat:init`

  - desc : 클라이언트가 서버와 소켓 통신을 하기 위해 chatrooms 네임스페이스로 연결을 맺을 때 정상적으로 연결이 성사되면 서버가 클라이언트로 접속 당시에 클라이언트가 참여 중인 방 리스트를 알려주기 발생하는 이벤트입니다. 클라이언트는 해당 이벤트가 발생하면 클라이언트가 참여 중인 방과 DM 목록을 적절히 렌더링합니다. 이때 클라이언트는 방 상세 정보를 받아오기 위해 HTTP API를 사용해 방의 추가 정보를 받아올 수 있습니다.

  - at : 채팅 세션이 성립되고 난 직후

  - to : 접속 요청한 클라이언트

  - 예시 data

    ```json
    {
      "rooms": [0, 2, 4] // 방/DM ID 배열
    }
    ```

- event : `room:leave`

  - desc : 유저가 방을 떠나거나 관리자에 의해 강퇴당할 때 발생하는 이벤트입니다. 본인이 방을 나가거나 강퇴당할 때, 본인을 포함한 방 인원들에게 모두 송부됩니다. 해당 이벤트를 받으면 클라이언트는 방의 멤버에서 해당 멤버를 제외시킵니다.

  - at : HTTP 요청으로 유저가 방을 나갈 때 (강퇴당할 때)

  - to : 나가는 (강퇴당하는) 클라이언트를 포함한 방에 속한 클라이언트들

  - 예시 data

    ```json
    {
      "chatSeq": 0, // 방 ID
      "userIDs": [1], // 나간 유저 ID 배열 (항상 크기가 1임)
      "kicked": false // 강퇴당했으면 true, 이외엔 false
    }
    ```

- event : `room:chat`

  - desc : 클라이언트가 서버로 채팅을 전송할 때나 알림 메시지 등을 채팅 포맷으로 보내줄 때 발생하는 이벤트이며 방 ID, 전달한 유저 ID, 메시지, 메시지 고유 ID를 보내줍니다. 만약 시스템 메시지일 경우 유저 ID는 0입니다. 해당 이벤트를 받으면 방에 채팅 메시지를 렌더링합니다.

  - at : 클라이언트가 서버로 채팅을 보낸 이후 / 서버가 알림 메시지를 생성할 때

  - to : 클라이언트가 속한 룸

  - 예시 data

    ```json
    {
      "chatSeq": 0, // 방 ID
      "userIDs": [12], // 채팅을 보낸 유저 ID (항상 크기가 1임)
      "msg": "안녕하세요", // 채팅 메시지 본문
      "id": 123 // 메시지의 고유 ID
    }
    ```

- event : `room:join`

  - desc : 기존 방에 새로운 유저가 추가되거나, 본인이 방에 추가되면 방과 유저들의 정보를 보내줍니다. 본인 및 다른 사람들에게도 발생하는 이벤트입니다. 이 이벤트가 발생하면 해당 방 리스트의 유저를 업데이트 해야 합니다.

  - at : 본인이 속한 방에 유저 추가

  - to : 방에 속한 클라이언트들

  - 예시 data

    ```json
    {
      "chatSeq": 1, // 방 ID
      "userIDs": [10, 12] // 들어온 유저 ID 배열
    }
    ```

- event : `grant`

  - desc : 유저 권한이 변경될 때 변경되었다고 알려줍니다. role 필드는 요구사항 정의서 문서 [링크](https://docs.google.com/spreadsheets/d/1Io0vCbHKBOxY5xH10IJMvuXHVHIXp8okB2LeFMkNzC4/edit#gid=1621334604) 의 마스터코드 탭에 ChatParticipant 라는 이름으로 명시되어 있습니다. 

  - at : 내가 속한 방에서 특정 유저의 권한이 변경될 때

  - to : 클라이언트가 속한 룸

  - 예시 data

    ```json
    {
      "chatSeq": 1, // 방 ID
      "userIDs": [12], // 권한이 변경된 유저 ID (항상 크기가 1임)
      "role": "CPAU20" // 관리자
    }
    ```

### 서버의 소켓 수신

서버에서 소켓 데이터를 수신할 때에는 다음 인터페이스를 준수합니다.

```tsx
interface ISocketRecv {
  content: string; // 메시지
  at: number; // 메시지를 보내고자 하는 룸 ID
}
```

- event : 

  ```
  chat
  ```

  - desc : 클라이언트가 방에 메시지를 보내기 위해 보내는 이벤트입니다.

  - at : 클라이언트가 메시지를 보낼 때

  - from : 클라이언트

  - 예시 data

    ```json
    {
      "content": "안녕하세요", // 메시지
      "at": 1 // 메시지를 보내고자 하는 룸 ID
    }
    ```